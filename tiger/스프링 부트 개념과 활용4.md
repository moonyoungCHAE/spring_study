# 스프링 부트 개념과 활용4

## Thymeleaf

스프링 부트가 자동 설정을 지원하는 탬플릿 엔진

- FreeMarker

- Groovy

- **Thymeleaf**

  - 비교적 최근에 만들어진 탬플릿

    ```
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
    ```

    SampleContorllerTest.class

    ```java
    import org.junit.jupiter.api.Test;
    import org.junit.runner.RunWith;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
    import org.springframework.test.context.junit4.SpringRunner;
    import org.springframework.test.web.servlet.MockMvc;
    
    import static org.hamcrest.Matchers.containsString;
    import static org.hamcrest.Matchers.is;
    import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
    import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;
    import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;
    
    @RunWith(SpringRunner.class)
    @WebMvcTest(SampleController.class)
    public class SampleControllerTest {
    
        @Autowired
        MockMvc mockMvc;
    
        @Test
        void hello() throws Exception {
            // 요청 "/hello"
            // 음답
            // - 모델 name : tigger
            // - 뷰 이름 : hello
    
            mockMvc.perform(get("/hello"))
                    .andExpect(status().isOk())
                    .andDo(print())
                    .andExpect(view().name("hello"))
                    .andExpect(model().attribute("name", is("tigger")))
                    .andExpect(content().string(containsString("tigger")));
        }
    }
    ```

    SampleController.class

    ```java
    import org.springframework.stereotype.Controller;
    import org.springframework.ui.Model;
    import org.springframework.web.bind.annotation.GetMapping;
    
    @Controller
    public class SampleController {
    
        @GetMapping("/hello")
        public String hello(Model model) {
            model.addAttribute("name", "tigger");
            return "hello";
        }
    }
    ```

- Mustache

## HtmlUnit

> html를 단위 테스트하기 위한 툴

의존성 추가

```
testImplementation 'org.seleniumhq.selenium:htmlunit-driver'
testImplementation 'net.sourceforge.htmlunit:htmlunit'
```

SampleControllerTest.class

```java
import com.gargoylesoftware.htmlunit.WebClient;
import com.gargoylesoftware.htmlunit.html.HtmlHeading1;
import com.gargoylesoftware.htmlunit.html.HtmlPage;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.test.context.junit4.SpringRunner;

import java.io.IOException;

import static org.assertj.core.api.Assertions.assertThat;

@RunWith(SpringRunner.class)
@WebMvcTest(SampleController.class)
public class SampleControllerTest {

    @Autowired
    WebClient webClient;

    @Test
    public void hello() throws IOException {
        HtmlPage page = webClient.getPage("/hello");
        HtmlHeading1 h1 = page.getFirstByXPath("//h1");
        assertThat(h1.getTextContent()).isEqualToIgnoringCase("Tigger");
    }
}
```

## ExceptionHandler

스프링 @MVC 예외 처리 방법

- @ControllerAdvice
- @ExchangeHandler

SampleController.class

```java
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ResponseBody;

@Controller
public class SampleController {

    @GetMapping("/hello")
    public String hello(Model model) {
        throw new SampleException();
    }

    @ExceptionHandler(SampleException.class)
    public @ResponseBody AppError sampleError(SampleException e) {
        AppError appError = new AppError();
        appError.setMessage("error.app.key");
        appError.setReason("IDK IDK IDK");
        return appError;
    }
}
```

스프링 부트가 제공하는 기본 예외 처리기

- BasicErrorController
  - HTML과 JSON 응답 지원
- 커스터마이징 방법
  - ErrorController 구현

커스텀 에러 페이지

- resources/static/template/error/

  - 404.html

    404에러시 띄워주는 페이지

  - 5xx.html

    500대 에러시 띄워주는 페이지

## Spring HATEOAS

```
implementation 'org.springframework.boot:spring-boot-starter-hateoas'
```

**H**ypermedia **A**s **T**he **E**ngine **O**f **A**pplication **S**tate

- 서버: 현재 리소스와 연관된 링크 정보를 클라이언트에게 제공한다.
- 클라이언트: 연관된 링크 정보를 바탕으로 리소스에 접근한다.

ObjectMapper 제공

- spring.jackson.*
- Jackson2ObjectMapperBuilder

SamplerController.class

```java
import org.springframework.hateoas.Resource;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import static org.springframework.hateoas.mvc.ControllerLinkBuilder.linkTo;
import static org.springframework.hateoas.mvc.ControllerLinkBuilder.methodOn;

@RestController
public class SampleController {

    @GetMapping("/hello")
    public Resource<Hello> hello() {
        Hello hello = new Hello();
        hello.setPrefix("Hey,");
        hello.setName("tigger");

        Resource<Hello> helloResource = new Resource<>(hello);
        helloResource.add(linkTo(methodOn(SampleController.class).hello()).withSelfRel());

        return helloResource;
    }
}
```

SampleControllerTest.class

```java
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.web.servlet.MockMvc;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@RunWith(SpringRunner.class)
@WebMvcTest(SampleController.class)
public class SampleControllerTest {

    @Autowired
    MockMvc mockMvc;

    @Test
    public void name() throws Exception {
        mockMvc.perform(get("/hello"))
                .andDo(print())
                .andExpect(status().isOk())
                .andExpect(jsonPath("$._links.self").exists());
    }
}
```

## CORS

SOP과 CORS 

- Single-Origin Policy
- Cross-Origin Resource Sharing 
- Origin? 
  - 밑의 3가지를 합친 것이 Origin이다.
  - URI 스키마 (http, https)
  - hostname (whiteship
  - 포트 (8080, 18080)

스프링 MVC @CrossOrigin

- @Controller나 @RequestMapping에 추가하거나 
- WebMvcConfigurer 사용해서 글로벌 설정

### 서버

SpringboottigerApplication

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@SpringBootApplication
@RestController
public class SpringboottigerApplication {

    @CrossOrigin(origins = "http://localhost:18080")
    @GetMapping("/hello")
    public String hello() {
        return "Hello";
    }

    public static void main(String[] args) {
        SpringApplication.run(SpringboottigerApplication.class, args);
    }
}
```

WebConfig.class

```java
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOrigins("http://localhost:18080");
    }
}
```

### 클라이언트

index.html

```html
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <h1>Cors</h1>

    <script>
        fetch("http://localhost:8080/hello").then(data => data.text())
        .then(data => {
            alert(data);
        }).catch(error => {
            alert(error);
        })
    </script>
</body>
</html>
```

application.properties

```
server.port=18080
```

## 인메모리 데이터베이스

의존성 추가

```
implementation 'org.springframework.boot:spring-boot-starter-jdbc'
runtime 'com.h2database:h2'
```

H2 콘솔 사용하는 방법

- spring-boot-devtools를 추가하거나...
- spring.h2.console.enabled=true 만 추가.
- /h2-console로 접속 (이 path도 바꿀 수 있음)

H2Runner.class

```java
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.ApplicationArguments;
import org.springframework.boot.ApplicationRunner;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.Statement;

@Component
public class H2Runner implements ApplicationRunner {

    @Autowired
    DataSource dataSource;

    @Autowired
    JdbcTemplate jdbcTemplate;

    @Override
    public void run(ApplicationArguments args) throws Exception {
        try(Connection connection = dataSource.getConnection()) {
            System.out.println(connection.getMetaData().getURL());
            System.out.println(connection.getMetaData().getUserName());

            Statement statement =  connection.createStatement();
            String sql = "CREATE TABLE USER(ID INTEGER NOT NULL, name VARCHAR(255), PRIMARY KEY(id))";
            statement.executeUpdate(sql);
        }
        jdbcTemplate.execute("INSERT INTO USER VALUES (1, 'tigger')");
    }
}
```

application.properties

```
spring.h2.console.enabled=true
```

http://localhost:8080/h2-console 들어가서 확인!!

## MySQL

지원하는 DBCP

1. HikariCP (기본)
   - https://github.com/brettwooldridge/HikariCP#frequently-used
2. Tomcat CP
3. Commons DBCP2

DBCP 설정

- spring.datasource.hikari.*
- spring.datasource.tomcat.*
- spring.datasource.dbcp2.*

gradle 의존성 추가

```
implementation("mysql:mysql-connector-java")
```

application.properties

```
spring.datasource.url=jdbc:mysql://localhost:3306/{Database-Name}?useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=utf8
spring.datasource.username=MySQL-username
spring.datasource.password=MySQL-password
```

## PostgreSQL

gradle 의존성 추가

```
compile group: 'org.postgresql', name: 'postgresql', version: '42.1.4'
```

